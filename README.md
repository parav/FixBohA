# FixBohA
Фикс для запуска игры Битва Героев: Кристалл Власти на современных компьютерах

Решил попробовать запустить БГ 1: Кристалл Власти на Windows 10 и как водится обломался: игра крешилась при запуске.
В связи с этим было решено неторопливо клепать патч для запуска игры под современные системы.
Добился некоторых успехов, чем и делюсь, хотя сразу предупреждаю что фикс тестировался только на железе одного компьютера (Win10, NVidia GTS 450).
Скомпилированный фикс БГ: КВ v 0.2: https://www.dropbox.com/s/rlq2k369sdmes1p/Boha_W10Fix_0_2.zip?dl=0
Требуется Visual C++ 2013 Redistributable: https://www.microsoft.com/en-us/download/details.aspx?id=40784

Установка: 
1) как обычно, установить БГ, аддон (в другую папку) и все ОФИЦИАЛЬНЫЕ патчи.
(т.е. пользовательский BOHLauncher, или как его окрестили фикс на графику на современные системы не нужен, т.к. предлагаемый фикс делает среди прочего то же, что делал и BOHLauncher; софтверные библиотеки рендера, или же из-под wined3d тоже не нужны, хотя если хотите можете попробовать).
2) Распокавать и скопировать r_battle.exe и _3d8.dll в папку с аддоном, заменяя файлы.
(для надежности можете оставить резервную копию экзешника; к сожаленю запустить экзешник не аддона не получилось (но я и не очень пытался, т.к. в оригинал можно поиграть и выбрав нужный пункт в меню аддона); кроме того, если вы почему-то скопировали экзешник до установки патчей, то патчами заменять его разумеется не нужно).
3) Играть.
(В принципе никакие режимы совместимости или права админа не нужны, поэтому если вы раньше экспериментировали с ними в попытке запустить, можете их убрать).
(Если будет ругаться на отсутсвие библиотек, попробуйте установить Visual C++ 2013 Redistributable из ссылки выше)

Компиляция:
Для компиляции для упрощения отладки стоит изменить пути размещения файлов и запуска программ в соответсвии с тем, где у вас расположен аддон. Кроме того в файле игры следует заменить любым шестнадцатеричным редактором все строки "d3d8.dll" на "_3d8.dll". В архиве на дропбоксе ради удобства кроме того, отменены ограничения на перемещения мыши, задаваемые фунцией ::ClipCursor(RECT*).

О патче v0.2:
0) Игра запускается и даже работает:)
1) Правда только в оконнмо режиме (форсируется переключение в оконный режим, здесь от вас ничего не зависит. Кроме того, для упрощения работы в настоящий момент используется всегда двойная буферизация, вне зависимости от настроек игры). Поддерживаются разрешения 800x600 и 1024x768 (выбираемые из меню игры или в настройках при первом запуске).
2) Остались баги:
 а) цвета: потемнение отдельных участков после выбора героя; однородная тень у зданий. Исправить это можно легко, но на мой взгляд не критично, а стоит для производительности слишком дорого (вы бы удивились). Исправление не планируется.
 б) иногда окно перемещается в левый верхний угол. Пока не разобрался из-за чего это происходит. В принципе можно поправить, или препарируя экзешник, или установив хуки. В любом случае скорее всего это потребует прилично времени, поэтому в ближайшее время не планируется.
 в) в некоторых меню нет внутриигрового указателя мыши. К сожалению игра видимо выводит его своими средствами как обычный спрайт, поэтому здесь я почти бессилен. Исправить скорее всего не смогу. Тем не менее, чтобы был хоть какой-то указатель мыши, не стал отключать системный, поэтому он рисуется поверх. Если будут пожелания, лучшее что смогу сделать - добавить хоткей для включения/выключения указателя мыши либо определять по каким-то косвенным признакам нужен ли он. Если кому-то будет очень нужно могу сделать.
 г) полноэкранного режима нет. Когда я попытался его установить там были проблемы то ли с буферами экрана, то ли обновлением, в общем спрайты там все мерцали, через кадр был черный цвет. Пока не разбирался в чем дело. Исправление возможно в отдаленом будущем.
 д) убрал ограничения на перемещения мыши, поэтому она свободно пересекает границы окна что для кого-то может быть не удобно.
 е) иногда (очень редко) игра фаталит при старте после ролика, если это случилось у вас более двух-трех раз подряд имеет смысл написать мне.
 ж) для любителей положил файл с редактором, но его только проверил на запускаемость, толком не протестировав.
 з) внутреннюю логику игры не менял, поэтому все баги, которые были изначально никуда не делись. 
4) Тестировалось очень мало, автор проверял на windows 10, вероятно поможет и на других системах. Многие вещи правились методом проб и ошибок, значит у вас будут баги, которых не было у меня или же баги, вызванные моими правками. Кроме того, пока не чистил код от спама сообщений отладчику и не оптимизровал его, но из-за этого проблем быть не должно.
Резюмируя: в настоящий момент я не вижу необходимости в внесении еще каких-либо исправлений, поэтому если не будет обоснованных просьб по вопросам в которых я смогу что-то изменить/замечаных критических багов, то вполне вероятно что следующая версия выйдет только через несколько месяцев/лет или же не выйдет никогда.
Любой имеет право свободно распространять и использовать этот фикс.


Приятной игры, надеюсь что смог помочь, pv.
